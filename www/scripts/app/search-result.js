"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var a=e[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,s,a){return s&&t(e.prototype,s),a&&t(e,a),e}}();define("app/search-result",["jquery","app/tpl/search/table-apartment"],function(t,e){return function(){function s(e){_classCallCheck(this,s),this.$forms=e.find("form"),this.$submit=e.find(".j-btn-more"),this.$results=e.find(".b-building__results"),this.$moreApartments=e.find(".j-building-more"),this.$shownApartmentsText=e.find(".b-building__shown-text"),this.$table=e.find(".b-building__table"),this.$ajaxLoader=t(".b-ajax-loader"),this.$ajaxLoaderInBtn=this.$ajaxLoader.clone().addClass("b-ajax-loader_theme_inside is-active"),this.$sorts=e.find(".j-sort"),this.$searchForm=t(".j-search-filter").find("form"),this.$sortInput=this.$searchForm.find("input[name=sort]"),this.$orderInput=this.$searchForm.find("input[name=order]"),this.$resultBtn=this.$searchForm.find(".b-search-filter__submit-btn"),this.$selectSort=e.find(".j-select-sort"),this.bindEvents()}return _createClass(s,[{key:"bindEvents",value:function(){this.$submit.on("click",this.openResult.bind(this)),this.$resultBtn.on("click",this.showResults.bind(this)),this.$moreApartments.on("click",this.bindClickMoreApartments.bind(this)),this.$sorts.on("click",this.sort.bind(this)),this.$selectSort.on("change",this.sort.bind(this))}},{key:"showResults",value:function(e){e.preventDefault();var s=this,a=this.$searchForm.serialize(),i=void 0;t.ajax({url:this.$searchForm.attr("action"),type:this.$searchForm.attr("method")||"post",dataType:"json",data:a,beforeSend:function(){s.$ajaxLoader.show()},success:function(e){s.$forms.each(function(a,n){i=t(n).find("input[name=object]").val(),i=parseInt(i);var r=t(n),o=e.building[i],l=r.find(".b-building__table"),d=r.find("input[name=page]"),u=o.results_show_text,c=r.find(".b-building__shown-text"),h=r.find(".j-building-more"),p=r.find(".j-btn-more");p.hasClass("is-active")?p.empty().text("Скрыть"):p.empty().text(o.toggle_btn_text),s.updateApartments(l,o),0===o.next_page?h.hide():(d.val(o.page),d.attr("data-next",o.next_page)),c.text(u)}),s.$ajaxLoader.hide(),window.history.pushState(null,null,"?"+a)}}),window.history.pushState(null,null,"?"+a)}},{key:"openResult",value:function(e){var s=t(e.target),a=s.closest("form"),i=this.$searchForm.serialize()+"&"+a.serialize();e.preventDefault(),s.next().slideToggle(),s.hasClass("is-active")?s.removeClass("is-active").empty().text(s.data("text")):s.addClass("is-active").empty().text("Скрыть"),window.history.pushState(null,null,"?"+i)}},{key:"bindClickMoreApartments",value:function(e){e.preventDefault();var s=this,a=t(e.target),i=a.closest("form"),n=parseInt(i.find("input[name=object]").val()),r=i.find("input[name=page]"),o=r.attr("data-next"),l=i.find(".b-building__shown-text"),d=a.text();o&&r.val(o);var u=this.$searchForm.serialize()+"&"+i.serialize();t.ajax({url:this.$searchForm.attr("action"),type:this.$searchForm.attr("method")||"post",dataType:"json",data:u,beforeSend:function(){s.$moreApartments.empty().prop("disabled",!0).append(s.$ajaxLoaderInBtn).addClass("is-disabled")},success:function(t){s.$moreApartments.empty().prop("disabled",!1).removeClass("is-disabled").text(d);var e=t.building[n];s.downloadApartment(a,e),0===e.next_page?s.$moreApartments.hide():(r.val(e.page),r.attr("data-next",e.next_page)),l.text(e.results_show_text),window.history.pushState(null,null,"?"+u)}})}},{key:"downloadApartment",value:function(t,s){var a=e(s);t.parents(".b-building__results").find("tbody").append(a)}},{key:"updateApartments",value:function(t,s){var a=e(s);t.parents(".b-building__results").find("tbody").empty().append(a)}},{key:"sort",value:function(e){e.preventDefault();var s=this,a=t(e.target),i=a.data("sort")||a.find("option:selected").data("sort"),n=a.attr("data-direction")||a.find("option:selected").data("direction"),r=a.closest("form"),o=parseInt(r.find("input[name=object]").val());a.parents("tr").find(".j-sort").each(function(){delete t(this)[0].dataset.direction,t(this).removeClass("b-building__sort_style_asc").removeClass("b-building__sort_style_desc")}),"asc"===n||void 0===n?(a.attr("data-direction","desc").removeClass("b-building__sort_style_asc").addClass("b-building__sort_style_desc"),n="asc"):a.attr("data-direction","asc").removeClass("b-building__sort_style_desc").addClass("b-building__sort_style_asc"),this.$sortInput.val(i),this.$orderInput.val(n);var l=this.$searchForm.serialize()+"&"+a.closest("form").serialize();t.ajax({url:this.$searchForm.attr("action"),type:this.$searchForm.attr("method")||"post",dataType:"json",data:l+"&no_offset=1",beforeSend:function(){s.$ajaxLoader.show()},success:function(t){var e=t.building[o];s.updateApartments(a,e),s.$ajaxLoader.hide(),window.history.pushState(null,null,"?"+l)}})}}]),s}()});
//# sourceMappingURL=../sourcemaps/app/search-result.js.map
