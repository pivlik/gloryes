"use strict";function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var o=i[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(i,e,o){return e&&t(i.prototype,e),o&&t(i,o),i}}();define(["jquery","infobox","app/google-map","app/tpl/map/tooltip","markerClusterer","app/functions"],function(t,i,e,o,n){return function(){function a(i){if(_classCallCheck(this,a),this.isMobile=t(window).width()<768,void 0===i.data("noinit")||!this.isMobile){var o=i.data(),n=window.map[i[0].id],s=t.extend(n,o);this.$map=i,this.data=s||{},this.markers=[],this.radiuses=[],this.markerOpen=-1,this.data.fit=s.fit,this.data.minZoom=s.minzoom||10,this.data.maxZoom=s.maxzoom||18,s.center&&(this.data.center=new e.maps.LatLng(s.center[0],s.center[1])),this.options={center:{lat:59.939552,lng:30.423428},zoom:12,zoomControlOptions:{position:e.maps.ControlPosition.RIGHT_CENTER},streetViewControl:!1,mapTypeControl:!1,styles:!1},this.options=t.extend(this.options,this.data),this.initCustomZoomControls(i),this.initMap(),this.clickCustomZoomControls(),this.initBounds(),this.initMarkers(),this.initRadiuses(),this.imageBoundsInit(),this.initInfoWindow(),this.editor(),this.initTabs()}}return _createClass(a,[{key:"initMap",value:function(){this.map=new e.maps.Map(this.$map[0],this.options)}},{key:"initMarkers",value:function(){var i=this;this.data.markers&&(this.data.imageBounds&&(this.data.markers[this.data.markers.length]={coords:this.data.imageBounds.coords,title:this.data.imageBounds.title,text:this.data.imageBounds.text,image:this.data.imageBounds.icon}),t.each(this.data.markers,function(t,e){i.initMarker(t,e)}))}},{key:"initRadiuses",value:function(){var i=this;this.data.radiuses&&t.each(this.data.radiuses,function(t,o){new e.maps.Circle({strokeColor:o.strokeColor,strokeOpacity:o.strokeOpacity,strokeWeight:o.strokeWeight,fillColor:o.fillColor,fillOpacity:o.fillOpacity,map:i.map,center:new e.maps.LatLng(o.center[0],o.center[1]),radius:o.radius})})}},{key:"initMarker",value:function(t,i){var o=new e.maps.LatLng(i.coords[0],i.coords[1]),n="string"!=typeof i.image?"/img/map/markers/marker.png":i.image,a=Array.isArray(i.sizes)&&2===i.sizes.length?function(t){return t.map(function(t){return parseInt(t)})}(i.sizes):[26,26];".svg"===n.match(/^\.|\.svg$|\.gif$|.jpg$|\.png$/i)[0]&&(n={url:n,scaledSize:new e.maps.Size(a[0],a[1])});var s={map:this.map,position:o,animation:e.maps.Animation.DROP,icon:n,type:i.type,optimized:!1},r=new e.maps.Marker(s);this.markers.push(r),r.setMap(this.map),void 0!==this.data.zoom&&void 0===this.data.fit||this.bounds.extend(o),this.bindMarkerClick(t,r,i)}},{key:"bindMarkerClick",value:function(t,i,n){var a=this;if(!n.title&&!n.text&&!n.url)return void i.setOptions({clickable:!1});e.maps.event.addListener(i,"click",function(){if(n.url)return void a.markerLink(n.url);a.infoWindow.setContent(o(n)),a.infoWindow.open(a.map,this),-1!==a.markerOpen&&a.markerShow(a.markerOpen),a.markerOpen=t,a.markerHide(t)})}},{key:"markerHide",value:function(t){this.markers[t].setVisible(!1)}},{key:"markerShow",value:function(t){this.markers[t].setVisible(!0)}},{key:"markerToggle",value:function(i){t.each(this.markers,function(t,e){if(e.type){var o=0===i||e.type===i;e.setVisible(o)}})}},{key:"initInfoWindow",value:function(){var o=this;this.infoWindow=new i({content:"",disableAutoPan:!1,maxWidth:0,pixelOffset:new e.maps.Size(-55,-83),zIndex:null,closeBoxMargin:"0px 0px 0px 0px",closeBoxURL:"",infoBoxClearance:new e.maps.Size(10,10),isHidden:!1,pane:"floatPane",enableEventPropagation:!1,boxStyle:{width:"auto"}}),e.maps.event.addListener(this.map,"click",function(){o.closeInfoWindow()}),this.infoWindow.addListener("domready",function(){var i=t(".infoBox"),n=void 0,a=void 0,s=i.find(".b-map-tooltip__arrow"),r=t(".b-map-tooltip__close"),m=i.find("img");m.length?m.load(function(){n=i.width(),a=i.height()+s.outerHeight(),o.infoWindow.setOptions({pixelOffset:new e.maps.Size(-n/2,-a)})}):(n=i.width(),a=i.height()+s.outerHeight(),o.infoWindow.setOptions({pixelOffset:new e.maps.Size(-n/2,-a)})),r.click(function(){o.closeInfoWindow()})})}},{key:"closeInfoWindow",value:function(){-1!==this.markerOpen&&this.markerShow(this.markerOpen),this.markerOpen=-1,this.infoWindow.close()}},{key:"markerLink",value:function(t){t.indexOf(window.location.origin)+1?window.location.href=t:window.open(t)}},{key:"imageBoundsInit",value:function(){if(this.data.imageBounds){var t=this,i={coords:this.data.imageBounds.coords,text:this.data.imageBounds.text,title:this.data.imageBounds.title},n=t.markers.length-1,a=this.data.imageBounds;this.imageBounds={north:a.north,west:a.west,south:a.south,east:a.east},this.historicalOverlay=new e.maps.GroundOverlay(a.image,this.imageBounds),this.historicalOverlay.setMap(this.map),e.maps.event.addListener(this.historicalOverlay,"click",function(){t.infoWindow.setContent(o(i)),t.infoWindow.open(t.map,t.markers[n]),t.markerHide(n)}),this.imageBoundsZoomChange()}}},{key:"imageBoundsZoomChange",value:function(){function t(t){t<=o?(i.historicalOverlay.setMap(null),i.markerShow(i.markers.length-1)):(i.historicalOverlay.setMap(i.map),i.markerHide(i.markers.length-1))}var i=this,e=this.map.getZoom(),o=14;t(e),this.map.addListener("zoom_changed",function(){e=i.map.getZoom(),t(e)})}},{key:"initBounds",value:function(){void 0!==this.data.zoom&&void 0===this.data.fit||(this.bounds=new e.maps.LatLngBounds,this.fitBounds(this.bounds))}},{key:"fitBounds",value:function(t){this.map.fitBounds(t)}},{key:"initCustomZoomControls",value:function(t){this.$zoomWrapper=t.next(".b-map__zoom-wrapper"),this.$zoomIn=this.$zoomWrapper.find(".b-map__zoom-in"),this.$zoomOut=this.$zoomWrapper.find(".b-map__zoom-out"),this.$zoomIn.length&&this.$zoomOut.length&&(this.options.zoomControl=!1)}},{key:"clickCustomZoomControls",value:function(){var t=this,i="is-hide";this.map.addListener("zoom_changed",function(){var e=t.map.getZoom();e===t.options.maxZoom?t.$zoomIn.addClass(i):t.$zoomIn.removeClass(i),e===t.options.minZoom?t.$zoomOut.addClass(i):t.$zoomOut.removeClass(i)}),this.$zoomIn.click(function(){t.map.setZoom(t.map.getZoom()+1),t.map.getZoom()===t.options.maxZoom?t.$zoomIn.addClass(i):t.$zoomOut.removeClass(i)}),this.$zoomOut.click(function(){t.map.setZoom(t.map.getZoom()-1),t.map.getZoom()===t.options.minZoom?t.$zoomOut.addClass(i):t.$zoomIn.removeClass(i)})}},{key:"initCluster",value:function(){return this.clusterOptions={styles:[{url:"http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m1.png",height:52,width:52}]},this.clusterOptions=t.extend(this.clusterOptions,this.data.clusterOptions),new n(this.map,this.markers,this.clusterOptions)}},{key:"initTabs",value:function(){var i=this.$map.parents(".b-map__cnt").find(".b-map-tabs");if(i.length){var o=this,n=i.find(".b-map-tabs__item"),a="is-active",s=i.find(".b-map-tabs__btn"),r=i.find(".b-map-tabs__list");n.click(function(i){i.preventDefault(),n.removeClass(a),t(this).addClass(a),o.closeInfoWindow(),o.markerToggle(t(this).find("a").data("type")),r.removeClass(a)}),s.click(function(t){t.preventDefault(),r.toggleClass(a)}),this.isMobile&&e.maps.event.addListener(this.map,"click",function(){r.removeClass(a)})}}},{key:"editor",value:function(){this.data.editor&&e.maps.event.addListener(this.map,"click",function(t){console.log("["+t.latLng.lat().toFixed(6)+","+t.latLng.lng().toFixed(6)+"]")})}}]),a}()});
//# sourceMappingURL=../sourcemaps/app/map.js.map
